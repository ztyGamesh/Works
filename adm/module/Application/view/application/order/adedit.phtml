<link rel="stylesheet" href="/css/jquery-ui-1.10.0.custom.css">
<?php
echo $this->partial('layout/formPublicHeader.phtml');
?>
<script src="/js/jquery-ui-1.10.0.custom.min.js" type="text/javascript"></script>
<div class="user-message-list">
    <div class="user-message-list-name">
        <ol>
            <li>
                <span id="companyName" class="user-message-name linkable"><a href="/order/ad">广告投放管理</a></span>
                <img class="separator" src="/img/arrow.png">
                <span id="adgroupName" class="user-message-name">修改广告投放</span>
            </li>
        </ol>
    </div>
</div>
<div class="Dl-fullscreen-line"></div>
<form id="edit" method="post" action="/order/adedit?uid=<?php echo $this->id; ?>" class="form-horizontal"
      onsubmit="return adeditVilidate();">

    <div style="width:100%;height:20px;padding-top: 10px">
        <?php if (isset($this->form['error'])) { ?>
            <div class="alert alert-danger alert-dismissible" role="alert">
                <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span
                        class="sr-only">Close</span></button>
                <strong>错误信息：</strong> <?php echo $this->form['error']; ?>
            </div>
        <?php } ?>
    </div>
<input type="hidden" name="plan_id" id="plan_id">
    <div class="form-group ">
        <label class="col-sm-3 control-label">广告投放属性:<span style="color:red"> *</span></label>
        <div class="col-sm-6 ">
            <input type="radio" name="class" id="optionsRadios1"
                   value="1" <?php if ($this->form['class'] == 1) echo 'checked="checked"' ?>> &nbsp;&nbsp;正常投放
            &nbsp; &nbsp; &nbsp; &nbsp;
            <input type="radio" name="class" id="optionsRadios2"
                   value="2" <?php if ($this->form['class'] == 2) echo 'checked="checked"' ?>>&nbsp;&nbsp;配送
            &nbsp; &nbsp; &nbsp; &nbsp;
            <input type="radio" name="class" id="optionsRadios3"
                   value="3" <?php if ($this->form['class'] == 3) echo 'checked="checked"' ?>>&nbsp;&nbsp;补量

        </div>
    </div>

    <div class="form-group ">
        <label class="col-sm-3 control-label">广告投放名称:<span style="color:red"> *</span></label>
        <div class="col-sm-6 ">
            <input id="name" type="text" name="name" class="form-control" value="<?php echo $this->form['name']; ?>">
            <small class="help-block" style="display: block;"></small>
        </div>
    </div>

    <div class="form-group ">
        <label class="col-sm-3 control-label">订单名称:<span style="color:red"> *</span></label>
        <div class="col-sm-6 ">
            <select id="order" name="order" class="form-control selectpicker" data-live-search="true" disabled>
                <?php
                foreach ($this->order_menu as $key => $val):?>
                    <option
                        value="<?php echo $key ?>" <?php if ($this->form['order'] == $key) echo 'selected="selected"' ?>><?php echo $val; ?></option>
                <?php endforeach; ?>
            </select>
        </div>


    </div>

    <div class="form-group ">
        <label class="col-sm-3 control-label">媒体名称:<span style="color:red"> *</span></label>
        <div class="col-sm-6 ">
            <select id="selF" class="form-control selectpicker" name="media" disabled>
                <option>选择媒体</option>
            </select>
        </div>
    </div>

    <div class="form-group ">
        <label class="col-sm-3 control-label">广告位:<span style="color:red"> *</span></label>
        <div class="col-sm-6 ">
            <select id="selT" class="form-control selectpicker" name="adslot" disabled>
                <option>选择广告位</option>
            </select>
        </div>
    </div>

    <div class="form-group ">
        <label class="col-sm-3 control-label">样式:<span style="color:red"> *</span></label>
        <div class="col-sm-6 ">
            <select id="selC" class="form-control selectpicker" name="template" disabled>
                <option>选择样式</option>
            </select>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-3 control-label">素材:<span style="color:red"> *</span></label>
        <div class="col-sm-5" style="padding-right: 0">
            <select id="material" name="material" class="form-control selectpicker">
                <option value="">选择素材</option>
            </select>
        </div>
        <div class="col-sm-1" style="padding-left: 0;">
            <div class="input-group">
                <span class="input-group-btn">
                    <button id="addMateriel" class="btn btn-default" type="button"
                            style="width: 100%;-webkit-border-radius: 0 4px 4px 0 ;-moz-border-radius: 0 4px 4px 0 ;border-radius: 0 4px 4px 0 ;">＋添加</button>
                </span>
            </div>
        </div>
        <small class="help-block" style="display: block;"></small>
    </div>

<!--    <div class="form-group ">-->
<!--        <label class="col-sm-3 control-label">素材:<span style="color:red"> *</span></label>-->
<!--        <div class="col-sm-6 ">-->
<!---->
<!--            <select id="material" name="material" class="form-control  selectpicker" data-live-search="true">-->
<!---->
<!--                --><?php
//
//                foreach ($this->materiel_menu as $key => $val):?>
<!--                    --><?php
//                    if ($this->form['material'] == $key) {
//
//                        ?>
<!--                        <option value="--><?php //echo $key ?><!--" selected="selected">--><?php //echo $val; ?><!--</option>-->
<!--                        --><?php
//                    } else {
//                        ?>
<!---->
<!--                        <option value="--><?php //echo $key ?><!--">--><?php //echo $val; ?><!--</option>-->
<!--                        --><?php
//                    }
//                    ?>
<!--                --><?php //endforeach; ?>
<!--            </select>-->
<!--        </div>-->
<!--    </div>-->

    <!--
    <div class="form-group ">
        <label class="col-sm-3 control-label">展现监测:</label>
        <div class="col-sm-6 ">
           <input id="imp_monitor" class="form-control" type="text" name="imp_monitor"  value="<?php echo $this->item['imp_monitor']; ?>">
        </div>
    </div>
    
    <div class="form-group ">
        <label class="col-sm-3 control-label">点击监测:</label>
        <div class="col-sm-6 ">
            <input id="cli_monitor" class="form-control" type="text" name="cli_monitor"  value="<?php echo $this->item['cli_monitor']; ?>">
        </div>
    </div>
    
    -->


    <div class="form-group hidden">
        <label class="col-sm-3 control-label">第三方点击监测地址:<span style="color:red"> *</span></label>
        <div class="col-sm-6 ">
            <input id="landing" class="form-control" type="text" name="landing"
                   value="<?php echo $this->form['landing']; ?>">
            <small class="help-block" style="display: block;"></small>
        </div>
    </div>
    <div class="form-group ">
        <label class="col-sm-3 control-label">第三方曝光监测地址:</label>
        <div class="col-sm-6 ">
            <input id="link_exposure" class="form-control" type="text" name="monitoring_url"
                   placeholder="请以http://或https://开头" value="">
            <small class="help-block" style="display: block;"></small>
        </div>
    </div>
    <div class="form-group" id="linkWrapper">
        <label class="col-sm-3 control-label">目标url:<span style="color:red"> *</span></label>
        <div class="col-sm-6 ">
            <input id="link" class="form-control" type="text" name="link" value="<?php echo $this->form['link']; ?>">
            <small class="help-block" style="display: block;"></small>
        </div>
    </div>

    <div class="form-group ">
        <label class="col-sm-3 control-label">结算方式:<span style="color:red"> *</span></label>
        <div class="col-sm-6 ">
            <input style="margin-right:10px" type="radio" name="sell_type" id="selltypeRadios1"
                   value="1" disabled>CPD
            <input style="margin-left:32px;margin-right:10px" type="radio" name="sell_type" id="selltypeRadios2"
                   value="2" disabled>轮播
            <!--            <input style="margin-left:32px;margin-right:10px" type="radio" name="sell_type" id="selltypeRadios3"-->
            <!--                   value="3" -->
            <?php //if ($this->form['sell_type'] == 3) echo 'checked="checked"' ?><!-- disabled>CPM-->
            <input type="hidden" name="sell_type" id="sell_type_value" value="1">
        </div>
    </div>

    <div class="form-group ">
        <label class="col-sm-3 control-label">投放周期:<span style="color:red"> *</span></label>
        <div class="col-sm-6 ">
            <input type="text" name="s" id="s" class="form-control"
                   style="width:100px;display:inline-block">
            <input type="text" name="e" id="e" class="form-control"
                   style="width:100px;display:inline-block">
        </div>
    </div>

    <div class="form-group ">
        <label class="col-sm-3 control-label">排期设定:<span style="color:red"> *</span></label>
        <div class="col-sm-6 ">
            <button type="button" id="setSchedule" class="btn btn-primary btn-small btn-block">设置排期详情</button>
            <input type="hidden" id="selected" name="selects">
            <small class="help-block" style="display: block;"></small>
        </div>
    </div>

    <div id="attr_1" <?php if ($this->form['sell_type'] == 3) { ?>style="display:none;"<?php } ?>>
        <div class="form-group hidden">
            <label class="col-sm-3 control-label">总预算:</label>
            <div class="col-sm-6 ">
                <input type="text" name="budget" id="budget" class="form-control"
                       value="<?php echo $this->form['budget']; ?>">
                <small class="help-block" style="display: block;"></small>
            </div>
        </div>
        <div class="form-group ">
            <label class="col-sm-3 text-right">样式刊例价:<span style="color:red"> *</span></label>
            <div class="col-sm-6 ">
                <div class="col-sm-6">
                    <span id="klj">＊</span><span id="kljUnit"></span>
                </div>
            </div>
        </div>

        <div class="form-group ">
            <label class="col-sm-3 control-label">实际计费单价:<span style="color:red"> *</span></label>
            <div class="col-sm-6 ">
                <input id="price" type="text" name="price" class="form-control"
                       value="<?php echo $this->form['price']; ?>">
                <small class="help-block" style="display: block;"></small>
            </div>
            <label id="price_unit"></label>
        </div>
    </div>

    <div id="attr_2" <?php if ($this->form['sell_type'] != 3) { ?> style="display:none;"<?php } ?>>
        <div class="form-group ">
            <label class="col-sm-3 control-label">选择定向:</label>
            <div class="col-sm-6 ">
                <select id="material" name="targeting" class="form-control  dropup" data-live-search="true">
                    <?php
                    foreach ($this->targeting_menu as $key => $val):?>
                        <option
                            value="<?php echo $key ?>" <?php if ($this->form['targeting'] == $key) echo 'selected="selected"' ?>><?php echo $val; ?></option>
                    <?php endforeach; ?>
                </select>
            </div>
        </div>

        <div class="form-group ">
            <label class="col-sm-3 control-label">CPM单价:</label>
            <div class="col-sm-6 ">
                <input type="text" name="cpm_price" id="cpm_price" class="form-control"
                       value="<?php echo $this->form['cpm_price']; ?>">
            </div>
        </div>

        <div class="form-group ">
            <label class="col-sm-3 control-label">日投放量:</label>
            <div class="col-sm-6 ">
                <input type="text" name="quota_daily" id="quota_daily" class="form-control"
                       value="<?php echo $this->form['quota_daily']; ?>">

            </div>
        </div>

        <div class="form-group ">
            <label class="col-sm-3 control-label">投放优先级:</label>
            <div class="col-sm-6 ">
                1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9
            </div>
            <div class="col-sm-6 ">
                <div id="slider"></div>
                <input id="slider_value" type="text" name="priority" type="hidden"/>
            </div>
            <div class="col-sm-12 ">
                <label class="col-sm-3 control-label"></label>
                最低&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;普通&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最高
            </div>
        </div>

        <div class="form-group ">
            <label class="col-sm-3 control-label">投放速度:</label>
            <div class="col-sm-6 ">
                <input type="radio" name="speed" id="optionsSpeedRadios1"
                       value="1" <?php if ($this->form['speed'] == 1) echo 'checked="checked"' ?>> &nbsp;&nbsp;尽快投放
                &nbsp; &nbsp; &nbsp; &nbsp;
                <input type="radio" name="speed" id="optionsSpeedRadios2"
                       value="2" <?php if ($this->form['speed'] == 2) echo 'checked="checked"' ?>>&nbsp;&nbsp;按流量平均投放
                <input type="radio" name="speed" id="optionsSpeedRadios3"
                       value="3" <?php if ($this->form['speed'] == 3) echo 'checked="checked"' ?>>&nbsp;&nbsp;按小时平均投放
            </div>
        </div>
    </div>


    <div class="form-group ">
        <label class="col-sm-3 control-label"></label>
        <div class="col-sm-6 ">
            <div style="padding-left:100px;">

                <button type="button"
                        style="width:120px;line-height:30px;background:#4183cd;font-size:12px;color:#fff;border-radius: 26px;margin-left:30px;"
                        onclick="javascript:window.location.href='/order/ad'">返回列表
                </button>
                <button type="submit"
                        style="width:120px;line-height:30px;background:#4183cd;font-size:12px;color:#fff;border-radius: 26px;">
                    保存修改
                </button>
            </div>
        </div>
    </div>

</form>

<!--排期设定-->
<link rel="stylesheet" href="/css/dialog/dialog.css">
<div class="dialog_wrapper" id="dialog_wrapper" style="display: none;">
    <div class="dialog_box">
        <div class="date_box">
            <div class="attention">
                <!--                注：修改排期时，距离投放日期开始前3天排期不能修改-->
            </div>
            <div id="data_wrapper">
                <div class="dates_wrapper">
                </div>
            </div>

            <div class="btn_box">
                <input type="button" value="确认" id="stock_submit">
                <input type="button" class="hidden" value="清空" id="stock_cancle">
                <input type="button" value="取消" id="stock_cancel">
            </div>
        </div>
        <img src="/images/left_btn_dialog.png" class="left_btn_dialog" id="left_btn_dialog">
        <img src="/images/right_btn_dialog.png" class="right_btn_dialog" id="right_btn_dialog">
    </div>
</div>





<link rel="stylesheet" href="/css/bootstrap-editable.css">

<script type="text/javascript" src="/js/bootstrap-editable.js"></script>
<script type="text/javascript" src="/js/jquery.form.js"></script>

<script type="text/javascript">
    // 验证权限
    checkActionAuth('/order/ad', 2);
    
    var isScheduledFlag = true;   //是否设定好了排期，默认填充好, 如果广告位类型 / 投放周期改变，需要清空排期存储域＃selected ，并isScheduledFlag设为false
    var linkWrapperIsShow = true; // 是否显示目标url

    //    轮播校验库存输入字段 注意：广告投放编辑特殊校验，输入最大值应该为当前库存量（分子）＋本次广告投放已选量
    function checkPurchase(arg) {
        arg.value = arg.value.replace(/\D/g, '0');
        if (arg.value > (parseInt(arg.getAttribute('inventory')) + parseInt(arg.getAttribute('selects')))) {
            layer.msg('购买量不能大于库存');
            arg.value = '0';
        }
    }

    // 验证
    function vaPrice(obj) {
        // 获取刊例价
        var klj = <?php echo json_encode($this->template_price);?>;
        for (var i in klj) {
            if (i == $("#selC").val()) {
                console.log("实际计价：" + obj.val());
                console.log("刊例价：" + parseFloat(klj[i]));
                if (parseFloat(obj.val()) <= parseFloat(klj[i])) {
                    console.log('通过实际计价与刊例价的验证，刊例价为：' + klj[i]);
                    return true;
                } else {
                    console.log('未通过实际计价与刊例价的验证，刊例价为：' + klj[i])
                }
            }
        }
        return false;
    }

    // 至少选择一天的排期
    function vaSelectedNotNull(obj) {
        var selected = obj.split(',');
        for (var i = 0; i < selected.length; i++) {
            if (selected[i] != '0') {
                return true;
            }
        }
        return false;
    }
    $('#material').change(function () {
        if (vaIsNotNull($(this).val())) {
            vaSuccess($(this));
        }
    });
    //校验规则：渠道不能空；手机号码可以空、校验格式；
    function adeditVilidate() {
        $("#Deepleaper_loading").show();
        // checkselT();
        var name = $('#name');
        var nameVal = name.val();
        var landing = $('#landing');
        var landingVal = landing.val();
        var link_exposure = $('#link_exposure');
        var link_exposureVal = link_exposure.val();
        var link = $('#link');
        var linkVal = link.val();
        var price = $('#price');
        var priceVal = price.val();

        if (!vaIsNotNull(nameVal)) {
            $("#Deepleaper_loading").hide();
            vaError(name, '请输入广告投放名称');
            return false;
        // } else if (!vaIsNotNull(landingVal)) {
        //     vaError(landing, '地址不能为空');
        //     return false;
        // } else if (!vaIsUrl(landingVal)) {
        //     vaError(landing, '地址应以http://或者https://开头');
        //     return false;
        } else if (!vaIsNotNull($("#material").val())) {
            $("#Deepleaper_loading").hide();
            vaError($("#material"), '素材不能为空');
            return false;
        } else if (vaIsNotNull(link_exposureVal) && (!vaIsUrl(link_exposureVal))) {
            $("#Deepleaper_loading").hide();
            vaError(link_exposure, '第三方曝光监测地址应以http://或者https://开头');
            return false;
        } else if (!vaIsNotNull(linkVal) && linkWrapperIsShow) {
            $("#Deepleaper_loading").hide();
            vaError(link, '地址不能为空');
            return false;
        } else if (!vaIsUrl(linkVal) && linkWrapperIsShow) {
            $("#Deepleaper_loading").hide();
            vaError(link, '地址应以http://或者https://开头');
            return false;
        } else if (!isScheduledFlag && (!vaIsNotNull($("#selected").val()) || !vaSelectedNotNull($('#selected').val()))) {
            $("#Deepleaper_loading").hide();
            vaError($("#selected"), '请进行排期设定');
            return false;
        } else if (!vaIsNotNull(priceVal)) {
            $("#Deepleaper_loading").hide();
            vaError(price, '请输入实际计费单价');
            return false;
        } else if (!vaIsMoney(priceVal)) {
            $("#Deepleaper_loading").hide();
            vaError(price, '输入格式有误，最多支持小数点后两位');
            return false;
        } else if (!vaPrice(price)) {
            $("#Deepleaper_loading").hide();
            vaError(price, '实际计费单价需要小于等于样式刊例价');
            return false;
        } else {
            $("#Deepleaper_loading").hide();
            $("#order").removeAttr('disabled');
            $("#selF").removeAttr('disabled');
            $("#selC").removeAttr('disabled');
            $("#selT").removeAttr('disabled');
            return true;
        }
    }


    $(function () {
        // 通用方法
        function setSelectedArray() {
            var selectedArray = [];
            if (sell_type == '2') {
                var canSubmit = $(".canSubmit");
                for (var i = 0; i < canSubmit.length; i++) {
                    var selectedValue = 0;
                    if (canSubmit[i].value !== "") {
                        selectedValue = parseInt(canSubmit[i].value);
                    }
                    selectedArray.push(selectedValue);
                }
            } else if (sell_type == '1') {
                var canSubmit = $(".canSubmit");
                for (var i = 0; i < canSubmit.length; i++) {
                    var selectedValue = 0;
                    if (canSubmit[i].checked) {
                        selectedValue = 1;
                    }
                    selectedArray.push(selectedValue);
                }
            }
            return selectedArray;
        }
      
        function setPopupValueBySelectedArray() {
            var selected = $('#selected').val().split(',');
            console.log(selected);
            if (sell_type == '2') {
                var objList = $('#data_wrapper input[type=text]');
                for (var i = 0; i < selected.length; i++) {
                    $(objList[i]).val(selected[i]);
                }
            } else if (sell_type == '1') {
                var objList = $('#data_wrapper input[type=checkbox]');
                for (var i = 0; i < selected.length; i++) {
                    if (selected[i] == '1') {
                        $(objList[i]).prop('checked', 'checked');
                    } else {
                        $(objList[i]).removeProp('checked');
                    }
                }
            }
        }

        function objInit(obj) {
            return $(obj).html("<option value=''>请选择</option>");
        }
      
        var sell_type;                // 结算方式

        var arrData =<?php echo $this->mst_select;?>;
        var arrsellData =<?php echo $this->slotsell_menu;?>;

        var media_select = "<?php echo $this->form['media_select'];?>";
        var slot_select = "<?php echo $this->form['slot_select'];?>";
        var template_select = "<?php echo $this->form['template'];?>";

        $.each(arrData, function (pF) {
            if (media_select == pF) {
                $("#selF").append('<option selected="selected">' + pF + '</option>');
            } else {
                $("#selF").append("<option>" + pF + "</option>");
            }
        });

        $.each(arrData, function (pF, pS) {
            if ($("#selF option:selected").text() == pF) {
                //遍历数据增加媒体项
                $.each(pS, function (pT, pC) {
                    if (slot_select == pT) {
                        $("#selT").append('<option selected="selected" uid=' + pC.uid + ' value = ' + pC.uid + '>' + pT + '</option>');

                        $.each(pC.template, function (pA, pB) {
                            if (template_select == pB) {
                                $("#selC").append('<option value="' + pB + '" selected="selected">' + pA + '</option>');
                            } else {
                                $("#selC").append('<option value="' + pB + '">' + pA + '</option>');
                            }
                        });
                    } else {
                        $("#selT").append('<option uid=' + pC.uid + ' value = ' + pC.uid + '>' + pT + '</option>');
                    }
                });
            }
        });
      
        // 订单周期时间
        bindRangeDatepicker($('#s'), $('#e'), new Date("<?php echo $this->form['s'];?>"), new Date("<?php echo $this->form['e'];?>"));
        $("#s").datepicker('setStartDate', "<?php echo $this->form['order_s'];?>");
        $("#e").datepicker('setEndDate', "<?php echo $this->form['order_e'];?>");
      
        //        模版改变， 刊例价改变 目标url状态改变
        var template_price = <?php echo json_encode($this->template_price);?>;
        for (var i in template_price) {
            if (i == $("#selC").val()) {
                $("#klj").html(parseFloat(template_price[i]));
            }
        }

        var template_click = <?php echo json_encode($this->template_click);?>;
        for (var i in template_click) {
            if (i == $("#selC").val()) {
                if (template_click[i] == 0) {
                    $("#linkWrapper").hide();
                    linkWrapperIsShow = false;
                    console.log('样式不支持点击，隐藏link');
                } else if (template_click[i] == 1) {
                    $("#linkWrapper").show();
                    linkWrapperIsShow = true;
                    console.log('样式支持点击，显示link');
                } else {
                    console.log('根据样式匹配 是否支持点击 失败！')
                }
            }
        }
      
        // 初始化默认排期表
        var isPageInit = true;
        media_slotinventory($("#selT option:selected").attr('uid'), '<?php echo $this->id; ?>', $("#s").val(), $("#e").val(), media_slotinventorySuccess);
        function media_slotinventorySuccess(result) {
            var res = JSON.parse(result);
            if (res.status == '1') {
                var data = res.data;
      
                var slot_inventory = data.slot_inventory; //slot_inventory广告位总量 作为分母
                var inventory = getJsonValue(data.inventory);//inventory 库存量 作为分子
                var selects = getJsonValue(data.selects);//selects 已选 填充
                var available_date = getJsonValue(data.available_date); //可编辑标识(后端判断根据目前距离3天内投放不能修改的设定) 0不可 1可以
                var total = getJsonLength(data.inventory);//total 总条数
                var pages = Math.ceil(total / 16);//总页数，每页16条
                var dataArray = getJsonKey(data.inventory);//日期数组
                sell_type = data.sell_type;//结算方式 1:CPD  2:轮播
                $('#kljUnit').html(sell_type == 1? '元/天': '元/轮播');
                $('#price_unit').html(sell_type == 1? '元/天': '元/轮播');
                console.log(sell_type);
                $('input[type=radio][name=sell_type][value=' + sell_type + ']').prop('checked', 'checked');
                $('input[type=hidden][name=sell_type]').val(sell_type);
      
                $("#data_wrapper").html('');
                var data_page = "";
                var data_flag = 0;
      
                if (sell_type == '2') {//轮播
                    for (var i = 0; i < pages; i++) {
                        if (i == 0) {
                            data_page += '<div class="dates_wrapper display_block">';
                        } else {
                            data_page += '<div class="dates_wrapper display_none">';
                        }
                        for (var j = 0; j < 16; j++) {
                            if (data_flag < dataArray.length) {//非空单元格
                                if (available_date[data_flag] == 1 && (inventory[data_flag] > 0 || selects[data_flag] > 0)) {//可以编辑
                                    var data_content = '<div class="date_content ">'
                                        + '<div class="time">' + dataArray[data_flag] + '</div>'
                                        + '<div class="stock backcolorCan">' + inventory[data_flag] + '/' + slot_inventory + '</div>'
                                        + '<input type="text" class="purchase canSubmit" placeholder="购买量" maxlength="1" selects="' + selects[data_flag] + '"  value="' + selects[data_flag] + '" inventory="' + inventory[data_flag] + '" onblur="checkPurchase(this);">'
                                        + '</div>';
                                } else if (available_date[data_flag] == 0 || available_date[data_flag] == 1) {//不可编辑
                                    var data_content = '<div class="date_content eneditable">'
                                        + '<div class="time">' + dataArray[data_flag] + '</div>'
                                        + '<div class="stock backcolorCant">' + inventory[data_flag] + '/' + slot_inventory + '</div>'
                                        + '<input type="text" class="purchase canSubmit backcolorCant" placeholder="不可买" disabled="disabled" selects="' + selects[data_flag] + '"  value="' + selects[data_flag] + '">'
                                        + '</div>';
                                } else {
                                    console.log('可编辑标识识别错误！');
                                }
                                data_flag += 1;
                            } else {//空单元格
                                var data_content = '<div class="date_content">'
                                    + '<div class="time" style="visibility: hidden">' + dataArray[data_flag] + '</div>'
                                    + '<div class="stock backcolorCan" style="visibility: hidden">' + inventory[data_flag] + '/' + slot_inventory + '</div>'
                                    + '<input type="text" class="purchase" placeholder="购买量" style="visibility: hidden">'
                                    + '</div>';
                            }
                            data_page += data_content;
                        }
                        data_page += '</div>';
                    }
                } else if (sell_type == '1') {//CPD
                    for (var i = 0; i < pages; i++) {
                        if (i == 0) {
                            data_page += '<div class="dates_wrapper display_block">';
                        } else {
                            data_page += '<div class="dates_wrapper display_none">';
                        }
                        for (var j = 0; j < 16; j++) {
                            if (data_flag < dataArray.length) {//非空单元格
                                var ischecked = '';
                                if (selects[data_flag] == 1) {//当已选时设为checked属性；
                                    ischecked = 'checked'
                                } else if (selects[data_flag] == 0 && inventory[data_flag] == 0) {//inventory库存量为0并且selects为0时表示被别人选中了，设为disabled;
                                    ischecked = 'disabled'
                                } else {//当selects未选，并且inventory库存量不为0时，设为未选、可选
                                    ischecked = ''
                                }
                                if (available_date[data_flag] == 1 || selects[data_flag] == 1) {//可以编辑
                                    var data_content = '<div class="date_content ">'
                                        + '<div class="time">' + dataArray[data_flag] + '</div>'
                                        + '<div class="checkbox"><label class="buy_label"><input type="checkbox" class="buy canSubmit"' + ischecked + '>购买</label></div>'
                                        + '</div>';
                                } else if (available_date[data_flag] == 0) {//不可编辑
                                    var data_content = '<div class="date_content eneditable">'
                                        + '<div class="time">' + dataArray[data_flag] + '</div>'
                                        + '<div class="checkbox"><label class="buy_label"><input type="checkbox" class="buy canSubmit" disabled="disabled" ' + ischecked + '>不可买</label></div>'
                                        + '</div>';
                                } else {
                                    console.log('可编辑标识识别错误！');
                                }
                                data_flag += 1;
                            } else {//空单元格
                                var data_content = '<div class="date_content">'
                                    + '<div class="time" style="visibility: hidden">' + dataArray[data_flag] + '</div>'
                                    + '<div class="checkbox"  style="visibility: hidden"><label class="buy_label"><input type="checkbox" class="buy">购买</label></div>'
                                    + '</div>';
                            }
                            data_page += data_content;
                        }
                        data_page += '</div>';
                    }
                }
                $("#data_wrapper").html(data_page);
//                layer.closeAll('loading');
                $("#Deepleaper_loading").hide();
                isPageInit? $('#dialog_wrapper').hide(): $('#dialog_wrapper').show();
                isPageInit = false;
                $('#selected').val(setSelectedArray());
            } else {
//                layer.closeAll('loading');
                $("#Deepleaper_loading").hide();
                alert("请求失败，返回信息：" + res.msg);
            }

        }
      
      
      
      
      
      
        // 事件绑定 - 主页面
        $("#selF").change(function () {
            objInit("#selT");
            objInit("#selC");

            $.each(arrData, function (pF, pS) {

                if ($("#selF option:selected").text() == pF) {
                    //遍历数据增加媒体项
                    $.each(pS, function (pT, pC) {

                        $("#selT").append('<option uid=' + pC.uid + ' value = ' + pC + '>' + pT + '</option>');
//                        $("#selT").append('<option value = ' + pC + '>' + pT + '</option>');

                    });

                    //媒体列表change事件
                    $("#selT").change(function () {
                        objInit("#selC");
                        $.each(pS, function (pT, pC) {
                            if ($("#selT option:selected").text() == pT) {

                                $.each(pC, function (pA, pB) {
                                    $("#selC").append('<option value="' + pB + '">' + pA + '</option>');
                                });
                            }
                            ;
                        });

                        // 变更售卖类型
                        $.each(arrsellData, function (pS, pN) {
                            if ($("#selT option:selected").text() == pS) {

                                switch (pN) {
                                    case '1':
                                        $('#selltypeRadios2').removeProp('checked');
                                        $('#selltypeRadios1').prop('checked', 'true');
                                        $('#sell_type_value').val(1);

//                                        $('#attr_1').show();
//                                        $('#attr_2').hide();
                                        break;
                                    case '2':
                                        $('#selltypeRadios1').removeProp('checked');
                                        $('#selltypeRadios2').prop('checked', 'true');
                                        $('#sell_type_value').val(2);
//                                        $('#attr_1').show();
//                                        $('#attr_2').hide();
                                        break;
//                                    case '3':
//                                        $('#selltypeRadios3').attr('checked', 'true');
//                                        $('#sell_type_value').val(3);
//                                        $('#selltypeRadios2').attr('checked', 'true');
//                                        $('#sell_type_value').val(2);
//                                        $('#attr_1').hide();
//                                        $('#attr_2').show();
//                                        break;
                                    default:
                                }
                            }
                        });
                    });
                }
            });
        });
      
        $('#name').blur(function () {
            if (!vaIsNotNull($(this).val())) {
                vaError($('#name'), '请输入广告投放名称');
            } else {
                vaSuccess($('#name'));
            }
        });
    //    $('#landing').blur(function () {
    //        if (!vaIsNotNull($(this).val())) {
    //            vaError($('#landing'), '地址不能为空');
    //        } else if (!vaIsUrl($('#landing').val())) {
    //            vaError($('#landing'), '地址应以http://或者https://开头');
    //        } else {
    //            vaSuccess($('#landing'));
    //        }
    //    });
        $('#link_exposure').blur(function () {
            if (vaIsNotNull($(this).val()) && (!vaIsUrl($(this).val()))) {
                vaError($('#link_exposure'), '第三方曝光监测地址应以http://或者https://开头');
            } else {
                vaSuccess($('#link_exposure'));
            }
        });
        $('#link').blur(function () {
            if (!vaIsNotNull($(this).val())) {
                vaError($('#link'), '地址不能为空');
            } else if (!vaIsUrl($('#link').val())) {
                vaError($('#link'), '地址应以http://或者https://开头');
            } else {
                vaSuccess($('#link'));
            }
        });
        $('#price').blur(function () {
            if (!vaIsNotNull($(this).val())) {
                vaError($('#price'), '请输入实际计费单价');
            } else if (!vaIsMoney($(this).val())) {
                vaError($('#price'), '实际计费单价输入格式有误，最多支持小数点后两位');
            } else if (!vaPrice($(this))) {
                vaError($('#price'), '实际计费单价需要小于等于样式刊例价');
            } else {
                vaSuccess($('#price'));
            }
        });
      
        //    查看排期按钮
        $("#setSchedule").bind('click', function () {
            if (isScheduledFlag) {
                $("#dialog_wrapper").show();
            } else {
                var ad = '<?php echo $this->id; ?>';
                var slot = $("#selT option:selected").attr('uid');
                var start = $("#s").val();
                var end = $("#e").val();
                if (slot == undefined) {
                    vaError($("#setSchedule"), '请先选择广告位名称');
                } else if (start == '' && end == '') {
                    vaError($("#setSchedule"), '请输入正确的投放周期');
                } else {
                    vaSuccess($("#setSchedule"));
//                    var layerLoading = layer.load(2);
                    $("#Deepleaper_loading").show();
                    media_slotinventory(slot, ad, start, end, media_slotinventorySuccess);
                }
            }
        });

      
      
      
        // 事件绑定 - 浮层部分
        //    确认按钮
        $("#stock_submit").bind('click', function () {
            //库存排期设定保存在隐藏域中，form表单提交
            $("#selected").val(setSelectedArray());
            $("#dialog_wrapper").hide();
            isScheduledFlag = true;
        });
      
        //    清空按钮
        $("#stock_cancle").bind('click', function () {
            isScheduledFlag = false;
            $("#dialog_wrapper").hide();
            $("#data_wrapper").html('');
            $("#selected").val("");
        });
      
        // 取消按钮
        $("#stock_cancel").bind('click', function () {
            $("#dialog_wrapper").hide();
            setPopupValueBySelectedArray();
        });

        //  排期左翻
        $("#left_btn_dialog").bind('click', function () {
            var now_wrapper = $(".display_block");
            if (now_wrapper.prev(".dates_wrapper").length !== 0) {
                now_wrapper.removeClass('display_block').addClass('display_none');
                now_wrapper.prev(".dates_wrapper").removeClass('display_none').addClass('display_block');
            } else {
                console.log('别按了我的哥，左边没啥了')
            }
        });
        //    排期右翻
        $("#right_btn_dialog").bind('click', function () {
            var now_wrapper = $(".display_block");
            if (now_wrapper.next(".dates_wrapper").length !== 0) {
                now_wrapper.removeClass('display_block').addClass('display_none');
                now_wrapper.next(".dates_wrapper").removeClass('display_none').addClass('display_block');
            } else {
                console.log('别按了我的哥，右边没啥了')
            }
        });
      
        function reChooseSchedule() {
            $("#selected").val("");
            isScheduledFlag = false;
        }
        $("#s").change(reChooseSchedule);
        $("#e").change(reChooseSchedule);
//        根据模板渲染素材
        getmaterialbytemplateAPI($("#selC").val(), getmaterialbytemplateAPIonSuccess);
        function getmaterialbytemplateAPIonSuccess(result) {
            var materialed = "<?php echo $this->form['material'];?>";
            var res = JSON.parse(result);
            if (res.status == '1' && res.data !== null) {
                objInit("#material");
                $.each(res.data, function (key, value) {
                    if(materialed == key){
                        $("#material").append('<option value="' + key + '" selected>' + value + '</option>');
                    }else{
                        $("#material").append('<option value="' + key + '">' + value + '</option>');
                    }
                });
                $(".selectpicker").selectpicker('refresh');
            }
        }
//        添加素材
        var materielType = 1;//1是非信息流，2是信息流

        var scaleArray = {
            '4_3': "4:3 800*600",
            '3_2': "3:2 960*640",
            '2_1': "2:1 600*300",
            '1_1': "1:1 800*800",
            '16_9': "16:9 1280*720",
            '6_5': "6:5 600*500",
            '4_9': "4:9 800*600",
            '3_6': "3:6 960*640",
            '2_3': "2:3 600*300",
            '1_3': "1:3 800*800",
            '16_27': "16:27 1280*720",
            '6_15': "6:15 600*500",
            '3:2': "3:2 960*640、480*320、320*213、320*210",
            '4:3': "4:3 800*600、400*300、200*150",
            '1:1': "1:1 800*800"
        };

        function checkinputfile(ele) {//ele下显示的上传控件，不能为空
            var flag = true;
            $("#" + ele + " input[type=file]").each(function () {
                if ($(this).closest('.form-group').css('display') == 'block' && !vaIsNotNull($(this).val())) {
                    vaError($(this), '请上传文件');
                    flag = false;
                } else {
                    vaSuccess($(this));
                }
            });
            return flag;
        }

        //添加素材
        $("#addMateriel").bind('click', function () {
            if ($("#selC").val() == "") {
                layer.msg('请选择样式');
            } else {
                $.ajax({
                    type: "get",
                    url: '/materiel/materieladd',
                    cache: false,
                    async: false,
                    success: function (data) {
                        layer.open({
                            type: 1,
                            area: '800px',
                            offset: '50px'
                            , btn: ['确认', '取消']
                            , success: function () {
                                $('.layui-layer-content').html(data);
                                fetchtemplateAPI($("#selC").val(), fetchtemplateAPIonSuccess);//根据选择的模板查素材 并渲染在'添加素材'中
                            }
                            , yes: function (index, layero) {
                                //按钮【按钮一】的回调
                                if (materielType == 1) {//非信息流
                                    var $form = $("#materielAdd");
                                    if (!vaIsNotNull($("#materielAdd input[name=name]").val())) {
                                        vaError($("#materielAdd input[name=name]"), '请输入素材名称');
                                        return false;
                                    } else if (!checkinputfile("materielAdd")) {//显示出来的上传框，必须传文件
                                        return false;
                                    } else {
                                        $form.ajaxSubmit({
                                            dataType: 'json',
                                            success: function (data) {
                                                if (data.status == 1) {
                                                    layer.msg('素材添加成功');
                                                    getmaterialbytemplateAPI($("#selC").val(), getmaterialbytemplateAPIonSuccess);
                                                    layer.close(index);
                                                } else {
                                                    layer.open({
                                                        type: 0,
                                                        title: '错误提示',
                                                        tipsMore : true,
                                                        content: "素材添加失败：" + data.msg,
                                                        yes: function(index, layero){
                                                            layer.close(index);
                                                        }
                                                    });
                                                    return false;
                                                }
                                            }
                                        });
                                    }
                                } else if (materielType == 2) {//信息流
                                    var $form = $("#type_infor_flow");
                                    if (!vaIsNotNull($("#type_infor_flow input[name=name]").val())) {
                                        vaError($("#type_infor_flow input[name=name]"), '请输入素材名称');
                                        return false;
                                    } else if(!vaIsNotNull($("#type_infor_flow input[name=title]").val())) {
                                        vaError($("#type_infor_flow input[name=title]"), '请输入标题');
                                        return false;
                                    } else if (!checkinputfile("type_infor_flow")) {//显示出来的上传框，必须传文件
                                        return false;
                                    } else {
                                        $form.ajaxSubmit({
                                            dataType: 'json',
                                            success: function (data) {
                                                console.log(data);
                                                if (data.status == 1) {
                                                    layer.msg('素材添加成功');
                                                    getmaterialbytemplateAPI($("#selC").val(), getmaterialbytemplateAPIonSuccess);
                                                    layer.close(index);
                                                } else {
                                                    layer.open({
                                                        type: 0,
                                                        title: '错误提示',
                                                        tipsMore : true,
                                                        content: "素材添加失败：" + data.msg,
                                                        yes: function(index, layero){
                                                            layer.close(index);
                                                        }
                                                    });
                                                    return false;
                                                }
                                            }
                                        });
                                    }
                                } else {//其他

                                }
                            }
                        });
                    }
                });
            }
        });

        function fetchtemplateAPIonSuccess(result) {
            var req = JSON.parse(result);
            console.log(req);
            if (req.status == '1') {
                var data_class = req.data.class;//广告位类型
                var val = adsType[data_class];

                for (var i = 0; i < val['show'].length; i++) {
                    var tag = val['show'][i];
                    $('.' + tag).show();
                }
                for (var i = 0; i < val['hide'].length; i++) {
                    var tag = val['hide'][i];
                    $('.' + tag).hide();
                }
                materielType = 1;
                $("#materielAdd #type").val(val['chinese']);//非信息流广告位方式需要传'素材的位类型'
                $('.layui-layer-content input[name=template]').val(req.data.uid);//广告位模板id，添加素材时提交
                if (req.data.material_type !== '视频' && req.data.class !== '19f6c554-fb2c-4604-8e66-51386e739b96') {//素材类型不等于视频 并且 不是信息流
                    $(".type_video").hide();
                } else if (req.data.class == '19f6c554-fb2c-4604-8e66-51386e739b96') {//如果是信息流广告位
                    materielType = 2;
                    var template_class = req.data.template_class; //模板类型
                    if (req.data.setting.video_setting !== undefined) { //是视频模板
                        $("#type_infor_flow .type_video").show();
                        $("#type_infor_flow .pics").hide();
                        $("#type_infor_flow .type_video .videoFormat").html(req.data.setting.video_setting.format);
                    } else if (template_class == "649592c0-7bc9-4372-a930-d2ad2b343e0b") {//组图
                        $("#type_infor_flow .pics").show();
                        $("#type_infor_flow .type_video").hide();
                    } else {
                        $("#type_infor_flow .pics").hide();
                        $("#type_infor_flow .type_video").hide();
                    }
                    $("#type_infor_flow #title").prop("maxLength", req.data.setting.title_setting.length);
                    $("#type_infor_flow #description").prop("maxLength", req.data.setting.description_setting.length);
                    $("#type_infor_flow .scale").html(scaleArray[req.data.setting.pic_setting.scale]);
                }
            } else {
                layer.msg("模板素材信息查询失败：" + req.msg);
            }
        }

        var adsType = {
            // app_开屏
            '3e2bbd3f-3e8a-4ddc-892a-12070890543c': {
                'show': ['type_splash'],                  // 当选该广告位类型时，需要显示的控件，下同
                'hide': ['type_banner', 'type_infor_flow'],                   // 当选该广告位类型时，需要隐藏的控件，下同
                'chinese': 'App_开屏'
            },
            // app_横幅
            '6e77385f-7834-11e6-a656-008cfaf6f0c0': {
                'show': ['type_banner'],
                'hide': ['type_splash', 'type_infor_flow'],
                'chinese': 'App_横幅'
            },
            // web_横幅
            '3b8930a2-84cb-11e6-a656-008cfaf6f0c0': {
                'show': ['type_banner'],
                'hide': ['type_splash', 'type_infor_flow'],
                'chinese': 'web_横幅'
            },
            // pc 固定位
            '44a1e8c4-d660-4ef2-bde7-84d3bc605880': {
                'show': ['type_banner'],
                'hide': ['type_splash', 'type_infor_flow'],
                'chinese': 'pc_固定位'
            },
            // pc 弹窗
            'ec7c2e0a-c3e2-46fe-af98-662e1b350d84': {
                'show': ['type_banner'],
                'hide': ['type_splash', 'type_infor_flow'],
                'chinese': 'pc_弹窗'
            },
            // app信息流
            '19f6c554-fb2c-4604-8e66-51386e739b96': {
                'show': ['type_infor_flow'],
                'hide': ['type_splash', 'type_banner', 'normal_template'],
                'chinese': 'App_信息流'
            }

        };
    });
</script>
